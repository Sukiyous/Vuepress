name: Deploy Docs

on:
  push:
    tags:
      - v*
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@v2

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: pnpm

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            **/node_modules
            .pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install deps
        run: pnpm install --frozen-lockfile || true

      - name: Build Packages
        run: pnpm build:package || true

      - name: Docs build
        env:
          NODE_OPTIONS: --max_old_space_size=8192
        run: pnpm docs:build || true

      - name: Upload build artifact
        uses: actions/upload-artifact@v3
        with:
          name: docs-dist
          path: docs/.vuepress/dist
          retention-days: 1

  deploy-github:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: docs-dist
          path: docs/.vuepress/dist

      - name: Create _headers file for cache control
        run: |
          cat > docs/.vuepress/dist/_headers << EOL
          /*
            Cache-Control: public, max-age=31536000, immutable
          /*.html
            Cache-Control: public, max-age=0, must-revalidate
          /service-worker.js
            Cache-Control: public, max-age=0, must-revalidate
          EOL

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: docs/.vuepress/dist
          single-commit: true

  deploy-gitee:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: docs-dist
          path: docs/.vuepress/dist

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Deploy to Gitee
        if: ${{ secrets.GITEE_USERNAME != '' && secrets.GITEE_PASSWORD != '' }}
        run: |
          mkdir -p /tmp/gh-pages
          cp -r docs/.vuepress/dist/* /tmp/gh-pages/

          cd /tmp/gh-pages
          git init
          git remote add origin https://${{ secrets.GITEE_USERNAME }}:${{ secrets.GITEE_PASSWORD }}@gitee.com/${{ secrets.GITEE_REPO }}.git
          git checkout -b gh-pages
          git add .
          git commit -m "Update Gitee Pages"
          git push -f origin gh-pages

      - name: Update Gitee Pages
        if: ${{ secrets.GITEE_USERNAME != '' && secrets.GITEE_PASSWORD != '' && secrets.GITEE_TOKEN != '' }}
        run: |
          curl -X POST --header 'Content-Type: application/json;charset=UTF-8' 'https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/pages/builds' -d '{"access_token":"${{ secrets.GITEE_TOKEN }}"}'
